<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cardiometabolic Health Dashboard (BRFSS 2015)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f3f4f6;
      --bg-panel: #ffffff;
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;

      /* 5 blue-ish colors (Material/Google-y) */
      --blue-1: #0d47a1;
      --blue-2: #1565c0;
      --blue-3: #1976d2;
      --blue-4: #1e88e5;
      --blue-5: #42a5f5;
      --accent: #1e88e5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #eef2ff;
      color: var(--text-main);
    }

    main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.5rem 1.75rem 2.5rem;
      background: linear-gradient(to bottom, #f9fafb, #eef2ff);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
      border-radius: 1.25rem;
      margin-top: 1rem;
      margin-bottom: 2rem;
    }

    h1 {
      margin: 0 0 0.25rem;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    p {
      margin: 0;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
      max-width: 820px;
      margin-bottom: 0.8rem;
    }

    /* Top tabs ------------------------------------------------------------ */

    .tabs-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      margin-top: 0.25rem;
    }

    .tab-buttons {
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 0.18rem;
    }

    .tab-button {
      border: none;
      background: transparent;
      padding: 0.25rem 0.9rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.18s ease, color 0.18s ease;
    }

    .tab-button.active {
      background: var(--accent);
      color: #ffffff;
    }

    /* Layout like the screenshot ---------------------------------------- */

    .dashboard {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 0.75rem;
      align-items: stretch;
    }

    @media (max-width: 900px) {
      .dashboard {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .sidebar {
      background: #f9fafb;
      border-radius: 0.75rem;
      border: 1px solid var(--border-subtle);
      padding: 0.75rem 0.8rem;
    }

    .sidebar h2 {
      font-size: 0.95rem;
      margin: 0 0 0.4rem;
      font-weight: 600;
    }

    .sidebar-group {
      margin-bottom: 0.75rem;
    }

    .sidebar label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.2rem;
    }

    select, input[type="number"] {
      width: 100%;
      border-radius: 0.45rem;
      border: 1px solid #d1d5db;
      padding: 0.3rem 0.55rem;
      font-size: 0.8rem;
      color: var(--text-main);
      background: #f9fafb;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    select:focus, input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.18);
      background: #ffffff;
    }

    select.placeholder, input.placeholder {
      color: #9ca3af;
    }

    .sidebar-note {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .main-panel {
      background: var(--bg-panel);
      border-radius: 0.75rem;
      border: 1px solid var(--border-subtle);
      padding: 0.75rem 0.9rem 0.8rem;
    }

    /* KPI / summary style ----------------------------------------------- */

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.45rem;
    }

    .kpi-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .kpi-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .kpi-card {
      background: #eff6ff;
      border-radius: 0.5rem;
      padding: 0.45rem 0.55rem;
      font-size: 0.8rem;
    }

    .kpi-label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .kpi-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--blue-2);
    }

    /* Charts area -------------------------------------------------------- */
    
.charts-grid {
  display: grid;
  grid-template-columns: minmax(0, 1.25fr) minmax(0, 1.1fr);
  gap: 0.75rem;
}

.charts-grid-rows {
  display: grid;
  grid-template-rows: 260px 260px; /* a bit taller and fixed */
  gap: 0.75rem;
}

@media (max-width: 900px) {
  .charts-grid,
  .charts-grid-rows {
    grid-template-columns: minmax(0, 1fr);
    grid-template-rows: none; /* let them grow naturally on small screens */
  }
}

    .chart-panel {
      border-radius: 0.5rem;
      border: 1px solid var(--border-subtle);
      padding: 0.45rem 0.55rem 0.3rem;
      background: #ffffff;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 0.82rem;
      font-weight: 600;
      margin-bottom: 0.1rem;
    }

    .chart-subtitle {
      font-size: 0.76rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .chart {
      flex: 1;
      min-height: 0;
    }

    svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    /* Profile summary (visible only when filled) ------------------------ */

    .profile-summary {
      margin-top: 0.5rem;
      font-size: 0.86rem;
      line-height: 1.5;
      color: var(--text-main);
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.35s ease, transform 0.35s ease;
    }

    .profile-summary.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .profile-summary strong.highlight {
      color: var(--blue-1);
      font-weight: 700;
    }

    .profile-summary em {
      color: var(--text-muted);
      font-style: normal;
    }

    /* Tabs content ------------------------------------------------------- */

    .tab-section {
      display: none;
    }

    .tab-section.active {
      display: block;
    }

    /* Notes -------------------------------------------------------------- */

    .notes {
      margin-top: 0.6rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .notes ul {
      padding-left: 1.1rem;
      margin: 0.2rem 0 0;
    }

    .notes li {
      margin-bottom: 0.15rem;
    }
  </style>
</head>
<body>
  <main>
    <h1>Cardiometabolic Health &amp; Disparities (BRFSS&nbsp;2015)</h1>
    <p class="subtitle">
      Use this dashboard to explore how <strong>diabetes, high blood pressure, high cholesterol, heart disease,</strong>
      and <strong>stroke</strong> vary across race/ethnicity, age, BMI, income, and education. Start on the
      <strong>Your Profile</strong> tab, then switch to <strong>General Statistics</strong> to see population patterns.
    </p>

    <div class="tabs-bar">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="profile-tab">Your profile</button>
        <button class="tab-button" data-tab="stats-tab">General statistics</button>
      </div>
    </div>

    <!-- TAB 1: YOUR PROFILE ---------------------------------------------->
    <section id="profile-tab" class="tab-section active">
      <div class="dashboard">
        <!-- Sidebar with your inputs -->
        <aside class="sidebar">
          <h2>Your information</h2>

          <div class="sidebar-group">
            <label for="profile-condition">Health issue</label>
            <select id="profile-condition" class="placeholder">
              <option value="">Choose a health issue…</option>
            </select>
          </div>

          <div class="sidebar-group">
            <label for="profile-age">Age group</label>
            <select id="profile-age" class="placeholder">
              <option value="">Choose an age group…</option>
            </select>
          </div>

          <div class="sidebar-group">
            <label for="profile-sex">Sex</label>
            <select id="profile-sex" class="placeholder">
              <option value="">Choose sex…</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>

          <div class="sidebar-group">
            <label for="profile-race">Race / ethnicity</label>
            <select id="profile-race" class="placeholder">
              <option value="">Choose race / ethnicity…</option>
            </select>
          </div>

          <div class="sidebar-group">
            <label for="profile-bmi">BMI (approx.)</label>
            <input id="profile-bmi" type="number" min="10" max="80" step="0.1" placeholder="e.g., 27" class="placeholder" />
          </div>

          <div class="sidebar-group">
            <label for="profile-income">Income</label>
            <select id="profile-income" class="placeholder">
              <option value="">Choose income…</option>
            </select>
          </div>

          <div class="sidebar-group">
            <label for="profile-education">Education</label>
            <select id="profile-education" class="placeholder">
              <option value="">Choose education…</option>
            </select>
          </div>

          <p class="sidebar-note">
            Fields must all be filled in before your personalized estimate appears.
            No values are stored; this is an educational visualization, not medical advice.
          </p>
        </aside>

        <!-- Main KPI + explanation panel -->
        <section class="main-panel">
          <div class="kpi-header">
            <div>
              <div class="kpi-title">Your profile vs. people like you</div>
              <div class="kpi-subtitle" id="profile-kpi-subtitle">
                Choose a health issue and fill in the panel on the left to see your estimated risk.
              </div>
            </div>
          </div>

          <div class="kpi-row" id="profile-kpis">
            <!-- two KPIs: your risk, group baseline -->
          </div>

          <div class="profile-summary" id="profile-summary">
            <!-- explanation text, filled dynamically -->
          </div>

          <div class="notes">
            <strong>How it works:</strong>
            <ul>
              <li>We find adults in BRFSS 2015 with the same race, sex, age group, income, education, and BMI within ±3 points.</li>
              <li>Your estimate is the share of that group who report the selected condition.</li>
              <li>We also compare to all adults of your race/ethnicity to highlight disparities.</li>
            </ul>
          </div>
        </section>
      </div>
    </section>

    <!-- TAB 2: GENERAL STATS --------------------------------------------->
    <section id="stats-tab" class="tab-section">
      <div class="dashboard">
        <!-- Sidebar filters -->
        <aside class="sidebar">
          <h2>Dashboard filters</h2>

          <div class="sidebar-group">
            <label for="stats-condition">Health issue</label>
            <select id="stats-condition" class="placeholder">
              <option value="">Choose a health issue…</option>
            </select>
          </div>

          <div class="sidebar-group">
            <label for="stats-race-filter">Race / ethnicity</label>
            <select id="stats-race-filter">
              <option value="all">All races</option>
            </select>
          </div>

          <div class="sidebar-group">
            <label for="stats-sex-filter">Sex</label>
            <select id="stats-sex-filter">
              <option value="all">All sexes</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>

          <div class="sidebar-group">
            <label for="stats-income-filter">Income</label>
            <select id="stats-income-filter">
              <option value="all">All incomes</option>
            </select>
          </div>

          <div class="sidebar-group">
            <label for="stats-education-filter">Education</label>
            <select id="stats-education-filter">
              <option value="all">All education levels</option>
            </select>
          </div>

          <p class="sidebar-note">
            Filters apply to the charts on the right. Use them to focus on particular subgroups,
            then compare patterns across race/ethnicity, age, and BMI.
          </p>
        </aside>

        <!-- Main KPIs + charts -->
        <section class="main-panel">
          <div class="kpi-header">
            <div>
              <div class="kpi-title">General statistics</div>
              <div class="kpi-subtitle" id="stats-kpi-subtitle">
                Select a health issue to view prevalence and disparities in the filtered population.
              </div>
            </div>
          </div>

          <div class="kpi-row" id="stats-kpis">
            <!-- sample size, avg prevalence, any condition -->
          </div>

          <div class="charts-grid" style="margin-top:0.2rem;">
            <div class="charts-grid-rows">
              <div class="chart-panel">
                <div class="chart-title">Prevalence by race / ethnicity</div>
                <div class="chart-subtitle">Bar chart (one bar per race group); ordered by prevalence.</div>
                <div class="chart" id="stats-race-chart"></div>
              </div>

              <div class="chart-panel">
                <div class="chart-title">Prevalence by age group</div>
                <div class="chart-subtitle">Bar chart over ordered age groups (18–24, 25–29, …, 80+).</div>
                <div class="chart" id="stats-age-chart"></div>
              </div>
            </div>

            <div class="chart-panel">
              <div class="chart-title">Prevalence by BMI category</div>
              <div class="chart-subtitle">Bar chart for underweight, normal, overweight, and obese adults.</div>
              <div class="chart" id="stats-bmi-chart"></div>
            </div>
          </div>

          <div class="notes">
            <strong>Notes:</strong>
            <ul>
              <li>All estimates are unweighted BRFSS 2015 proportions and should be interpreted as approximate.</li>
              <li>The same health issue is used across all charts to make comparisons easier.</li>
              <li>Bar charts are used because each group is categorical with no continuous time dimension.</li>
            </ul>
          </div>
        </section>
      </div>
    </section>
  </main>

  <script>
    const conditionLabels = {
      diabetes: "Diabetes",
      high_bp: "High blood pressure",
      high_chol: "High cholesterol",
      heart_disease: "Heart disease / heart attack",
      stroke: "Stroke",
    };

    const conditionOrder = ["diabetes", "high_bp", "high_chol", "heart_disease", "stroke"];
    const bluePalette = ["#0d47a1", "#1565c0", "#1976d2", "#1e88e5", "#42a5f5"];

    // Tab switching --------------------------------------------------------
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.tab;
        document.querySelectorAll(".tab-button").forEach(b => b.classList.toggle("active", b === btn));
        document.querySelectorAll(".tab-section").forEach(sec => {
          sec.classList.toggle("active", sec.id === target);
        });
      });
    });

    // Load data ------------------------------------------------------------
    d3.csv("brfss2015_health_clean.csv").then(raw => {
      const data = raw.map(d => ({
        race: d.race || null,
        sex: d.sex || null,
        age_group: d.age_group || null,
        age_num: d.age_num ? +d.age_num : null,
        bmi: d.bmi ? +d.bmi : null,
        bmi_cat: d.bmi_cat || null,
        education: d.education || null,
        income: d.income || null,
        diabetes: d.diabetes === "" ? null : +d.diabetes,
        high_bp: d.high_bp === "" ? null : +d.high_bp,
        high_chol: d.high_chol === "" ? null : +d.high_chol,
        heart_disease: d.heart_disease === "" ? null : +d.heart_disease,
        stroke: d.stroke === "" ? null : +d.stroke,
      }));

      const races = Array.from(new Set(data.map(d => d.race))).filter(Boolean).sort();
      const incomes = Array.from(new Set(data.map(d => d.income))).filter(Boolean);
      const educations = Array.from(new Set(data.map(d => d.education))).filter(Boolean);
      const ageGroups = Array.from(new Set(data.map(d => d.age_group))).filter(Boolean);

      // Populate selects ---------------------------------------------------
      const profileRace = d3.select("#profile-race");
      races.forEach(r => profileRace.append("option").attr("value", r).text(r));

      const profileAge = d3.select("#profile-age");
      ageGroups.forEach(a => profileAge.append("option").attr("value", a).text(a));

      const profileIncome = d3.select("#profile-income");
      incomes.forEach(v => profileIncome.append("option").attr("value", v).text(v));

      const profileEducation = d3.select("#profile-education");
      educations.forEach(v => profileEducation.append("option").attr("value", v).text(v));

      const profileCond = d3.select("#profile-condition");
      const statsCond = d3.select("#stats-condition");
      conditionOrder.forEach(key => {
        profileCond.append("option").attr("value", key).text(conditionLabels[key]);
        statsCond.append("option").attr("value", key).text(conditionLabels[key]);
      });

      const statsRaceFilter = d3.select("#stats-race-filter");
      races.forEach(r => statsRaceFilter.append("option").attr("value", r).text(r));

      const statsIncomeFilter = d3.select("#stats-income-filter");
      incomes.forEach(v => statsIncomeFilter.append("option").attr("value", v).text(v));

      const statsEducationFilter = d3.select("#stats-education-filter");
      educations.forEach(v => statsEducationFilter.append("option").attr("value", v).text(v));

      // Shared helpers -----------------------------------------------------
      function prevalenceBy(groupKey, cond, subset) {
        const grouped = d3.group(subset, d => d[groupKey]);
        const result = [];
        for (const [key, values] of grouped.entries()) {
          if (!key) continue;
          const withCond = values.filter(v => v[cond] === 1).length;
          const total = values.length;
          if (!total) continue;
          result.push({ key, total, prevalence: withCond / total });
        }
        return result.sort((a, b) => a.prevalence - b.prevalence);
      }

      function drawBarChart(containerId, dataPoints, {
        yLabel = "",
        rotateX = false,
      } = {}) {
        const container = d3.select(containerId);
        container.selectAll("*").remove();

        const width = container.node().clientWidth || 400;
        const height = container.node().clientHeight || 220;
        const margin = { top: 10, right: 10, bottom: rotateX ? 80 : 40, left: 60 };

        const svg = container.append("svg")
          .attr("width", width)
          .attr("height", height);

        if (!dataPoints.length) {
          svg.append("text")
            .attr("x", width / 2)
            .attr("y", height / 2)
            .attr("text-anchor", "middle")
            .attr("fill", "#9ca3af")
            .text("Select a health issue to view this chart.");
          return;
        }

        const x = d3.scaleBand()
          .domain(dataPoints.map(d => d.key))
          .range([margin.left, width - margin.right])
          .padding(0.25);

        const y = d3.scaleLinear()
          .domain([0, d3.max(dataPoints, d => d.prevalence) * 1.1])
          .nice()
          .range([height - margin.bottom, margin.top]);

        const xAxis = g => g
          .attr("transform", `translate(0,${height - margin.bottom})`)
          .call(d3.axisBottom(x).tickSizeOuter(0))
          .selectAll("text")
          .style("font-size", "10px")
          .attr("fill", "#4b5563")
          .call(sel => {
            if (rotateX) {
              sel.attr("text-anchor", "end")
                .attr("transform", "rotate(-35)")
                .attr("dx", "-0.6em")
                .attr("dy", "0.25em");
            }
          });

        const yAxis = g => g
          .attr("transform", `translate(${margin.left},0)`)
          .call(d3.axisLeft(y).ticks(5).tickFormat(d => d * 100 + "%"))
          .selectAll("text")
          .style("font-size", "10px")
          .attr("fill", "#4b5563");

        svg.append("g").call(xAxis);
        svg.append("g").call(yAxis);

        svg.selectAll("rect.bar")
          .data(dataPoints)
          .enter()
          .append("rect")
          .attr("class", "bar")
          .attr("x", d => x(d.key))
          .attr("y", d => y(d.prevalence))
          .attr("width", x.bandwidth())
          .attr("height", d => y(0) - y(d.prevalence))
          .attr("fill", (_, i) => bluePalette[i % bluePalette.length]);

        svg.append("text")
          .attr("x", margin.left)
          .attr("y", margin.top + 4)
          .attr("fill", "#6b7280")
          .attr("font-size", 10)
          .text(yLabel);
      }

      // PROFILE TAB --------------------------------------------------------
      function profileComplete() {
        const cond = d3.select("#profile-condition").property("value");
        const age = d3.select("#profile-age").property("value");
        const sex = d3.select("#profile-sex").property("value");
        const race = d3.select("#profile-race").property("value");
        const bmiVal = parseFloat(d3.select("#profile-bmi").property("value"));
        const income = d3.select("#profile-income").property("value");
        const educ = d3.select("#profile-education").property("value");
        return !!(cond && age && sex && race && income && educ && !isNaN(bmiVal));
      }

      function updateProfile() {
        const summaryEl = d3.select("#profile-summary");
        const kpiContainer = d3.select("#profile-kpis");
        const subtitleEl = d3.select("#profile-kpi-subtitle");

        kpiContainer.selectAll("*").remove();

        if (!profileComplete()) {
          summaryEl.classed("visible", false).html("");
          subtitleEl.text("Choose a health issue and fill in the panel on the left to see your estimated risk.");
          return;
        }

        const cond = d3.select("#profile-condition").property("value");
        const condLabel = conditionLabels[cond];
        const age = d3.select("#profile-age").property("value");
        const sex = d3.select("#profile-sex").property("value");
        const race = d3.select("#profile-race").property("value");
        const bmiVal = parseFloat(d3.select("#profile-bmi").property("value"));
        const income = d3.select("#profile-income").property("value");
        const educ = d3.select("#profile-education").property("value");

        const similar = data.filter(d => {
          if (d[cond] == null) return false;
          if (d.age_group !== age) return false;
          if (d.sex !== sex) return false;
          if (d.race !== race) return false;
          if (d.income !== income) return false;
          if (d.education !== educ) return false;
          if (d.bmi == null) return false;
          if (Math.abs(d.bmi - bmiVal) > 3) return false;
          return true;
        });

        const nSimilar = similar.length;
        const prev = nSimilar ? d3.mean(similar, d => d[cond]) : null;

        const baselineGroup = data.filter(d => d[cond] != null && d.race === race);
        const baselinePrev = baselineGroup.length ? d3.mean(baselineGroup, d => d[cond]) : null;

        subtitleEl.text(condLabel + " among adults most similar to your profile.");

        if (!nSimilar || prev == null || baselinePrev == null) {
          summaryEl
            .classed("visible", true)
            .html(`
              We couldn't find enough adults in BRFSS 2015 with a very similar profile to estimate risk for
              <strong class="highlight">${condLabel}</strong>.<br><br>
              <em>Try adjusting BMI or income slightly, or switch to the General statistics tab to explore broader patterns.</em>
            `);
          return;
        }

        const pct = (prev * 100).toFixed(1);
        const baselinePct = (baselinePrev * 100).toFixed(1);
        const ratio = prev / baselinePrev;
        let relation = "about the same as";
        if (ratio >= 1.2) relation = "higher than";
        if (ratio <= 0.8) relation = "lower than";

        // KPIs
        const kpis = [
          {
            label: "Estimated prevalence in your profile group",
            value: pct + "%",
          },
          {
            label: `Prevalence among all ${race} adults`,
            value: baselinePct + "%",
          },
          {
            label: "Number of people with similar profile in sample",
            value: nSimilar.toLocaleString(),
          },
        ];

        const cards = kpiContainer.selectAll(".kpi-card")
          .data(kpis)
          .enter()
          .append("div")
          .attr("class", "kpi-card");

        cards.append("div").attr("class", "kpi-label").text(d => d.label);
        cards.append("div").attr("class", "kpi-value").text(d => d.value);

        summaryEl
          .classed("visible", true)
          .html(`
            Among <strong class="highlight">${nSimilar.toLocaleString()}</strong> adults in BRFSS 2015 with a profile
            similar to yours (same race, sex, age group, income, education, and BMI ±3),
            about <strong class="highlight">${pct}%</strong> report having
            <strong class="highlight">${condLabel.toLowerCase()}</strong>.<br><br>
            Among all <strong>${race}</strong> adults in the survey, about
            <strong class="highlight">${baselinePct}%</strong> have ${condLabel.toLowerCase()}.
            This suggests that your estimated risk is <strong class="highlight">${relation}</strong>
            the average for your race/ethnicity group in this dataset.<br><br>
            <em>These are rough sample estimates for visualization practice only and do not constitute medical advice.</em>
          `);
      }

      // GENERAL STATS TAB --------------------------------------------------
      function getStatsSubset() {
        const cond = d3.select("#stats-condition").property("value");
        if (!cond) return [];

        const raceSel = d3.select("#stats-race-filter").property("value");
        const sexSel = d3.select("#stats-sex-filter").property("value");
        const incomeSel = d3.select("#stats-income-filter").property("value");
        const educSel = d3.select("#stats-education-filter").property("value");

        return data.filter(d => {
          if (d[cond] == null) return false;
          if (raceSel !== "all" && d.race !== raceSel) return false;
          if (sexSel !== "all" && d.sex !== sexSel) return false;
          if (incomeSel !== "all" && d.income !== incomeSel) return false;
          if (educSel !== "all" && d.education !== educSel) return false;
          return true;
        });
      }

      function updateStats() {
        const cond = d3.select("#stats-condition").property("value");
        const kpiContainer = d3.select("#stats-kpis");
        const subtitle = d3.select("#stats-kpi-subtitle");
        kpiContainer.selectAll("*").remove();

        if (!cond) {
          subtitle.text("Select a health issue to view prevalence and disparities in the filtered population.");
          ["#stats-race-chart", "#stats-age-chart", "#stats-bmi-chart"].forEach(id =>
            d3.select(id).selectAll("*").remove()
          );
          return;
        }

        const subset = getStatsSubset();
        subtitle.text(conditionLabels[cond] + " in the filtered population.");

        const total = subset.length;
        const avgPrev = total ? d3.mean(subset, d => d[cond]) : null;

        const any = subset.filter(d => {
          const vals = [d.diabetes, d.high_bp, d.high_chol, d.heart_disease, d.stroke];
          return vals.some(v => v === 1);
        });
        const anyPrev = total ? any.length / total : null;

        const kpis = [
          { label: "Sample size under filters", value: total.toLocaleString() },
          {
            label: `Average prevalence of ${conditionLabels[cond]}`,
            value: avgPrev != null ? (avgPrev * 100).toFixed(1) + "%" : "N/A",
          },
          {
            label: "Any of the five cardiometabolic conditions",
            value: anyPrev != null ? (anyPrev * 100).toFixed(1) + "%" : "N/A",
          },
        ];

        const cards = kpiContainer.selectAll(".kpi-card")
          .data(kpis)
          .enter()
          .append("div")
          .attr("class", "kpi-card");

        cards.append("div").attr("class", "kpi-label").text(d => d.label);
        cards.append("div").attr("class", "kpi-value").text(d => d.value);

        // charts (all bars)
        const byRace = prevalenceBy("race", cond, subset);
        drawBarChart("#stats-race-chart", byRace, {
          yLabel: "% with " + conditionLabels[cond],
          rotateX: true,
        });

        const byAge = prevalenceBy("age_group", cond, subset);
        drawBarChart("#stats-age-chart", byAge, {
          yLabel: "% with " + conditionLabels[cond],
        });

        const byBmi = prevalenceBy("bmi_cat", cond, subset);
        drawBarChart("#stats-bmi-chart", byBmi, {
          yLabel: "% with " + conditionLabels[cond],
        });
      }

      // Sync condition between tabs so user doesn't have to pick twice
      function syncConditions(fromProfile) {
        const profileVal = d3.select("#profile-condition").property("value");
        const statsVal = d3.select("#stats-condition").property("value");
        if (fromProfile && profileVal && profileVal !== statsVal) {
          d3.select("#stats-condition").property("value", profileVal);
        }
        if (!fromProfile && statsVal && statsVal !== profileVal) {
          d3.select("#profile-condition").property("value", statsVal);
        }
      }

      // Event hooks --------------------------------------------------------
      d3.selectAll("#profile-condition, #profile-age, #profile-sex, #profile-race, #profile-bmi, #profile-income, #profile-education")
        .on("change", function() {
          if (this.id === "profile-condition") {
            syncConditions(true);
            updateStats();
          }
          updateProfile();
        });

      d3.selectAll("#stats-condition, #stats-race-filter, #stats-sex-filter, #stats-income-filter, #stats-education-filter")
        .on("change", function() {
          if (this.id === "stats-condition") {
            syncConditions(false);
            updateProfile();
          }
          updateStats();
        });

      // Initial blank state
      updateProfile();
      updateStats();
    }).catch(err => {
      console.error("Error loading CSV:", err);
      alert("Error loading brfss2015_health_clean.csv. Make sure it is in the same folder as index.html.");
    });
  </script>
</body>
</html>